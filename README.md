# lockfile
> Read and write lockfiles with reasonable losses

## Motivation
Each package manager brings its own philosophy of how to describe, store and control project dependencies.
It _seems_ acceptable for developers, but literally becomes a ~~pain in *** ***~~ headache for isec, devops and release engineers.
This lib is a naive attempt to build a pm-independent, generic, extensible and reliable deps representation.

The ´package.json´ manifest contains its own deps requirements, the `lockfile` holds the deps resolution snapshot<sup>*</sup>,
so both of them are required to build a dependency graph. We can try to convert this data into a normalized representation for further analysis and processing (for example, to fix vulnerabilities).
And then, if necessary, convert it back to the original format.

## Status
⚠️ Initial draft. Alpha-version

## Getting started
### Install
```shell
yarn add @antongolub/lockfile
```

### Usage
```js
import { parse, format } from '@antongolub/lockfile'

const parsed = parse({
  lockfile: './yarn.lock',
  workspaces: {'': './package.json', 'foo': './packages/foo/package.json'},
})

// output
{
  entries: {
    '@babel/code-frame@7.10.4': {
      name: '@babel/code-frame',
      version: '7.10.4',
      scope: 'prod/dev/peer/opt',
      integrities: {
        sha512: 'hashsum',
        sha256: '...',
        sha1: '...',
        md5: '...'
      },
      reference: {
        sourceType: 'npm/git/file/workspace'
        source: 'uri://remote/address',
        linkType: 'hard/soft',
        link: '<root>path/to/package'
      },
      dependencies: {
        '@babel/highlight': '^7.10.4'
      }
    },
    ...
  },
  meta: {
    lockfile: {
      type: 'yarn',
      version: '5', // metadata format version
    },
    packageJson: {...},
    workspaces: {
      patterns: ['./packages/*'],
      packages: {
        '@qiwi/pijma-core': '<root>/packages/core/package.json'
      }
    }
  },
}

const data = format({
  ...parsed,
  lockfileType: 'yarn-2'
})
// output
`
# This file is generated by running "yarn install" inside your project.
# Manual changes might be lost - proceed with caution!

__metadata:
  version: 5
  cacheKey: 8

"@babel/code-frame@npm:7.10.4":
  version: 7.10.4
  resolution: "@babel/code-frame@npm:7.10.4"
...
`
```

### Lockfiles formats
| Package manager  | Meta format | Read | Write |
|------------------|-------------|------|-------|
| npm <7           | 1           | ✓    | ✓     |
| npm >=7          | 2           | ✓    |       |
| npm >=9          | 3           |      |       | 
| yarn 1 (classic) | 1           | ✓    | ✓     |
| yarn 2 (berry)   | 5, 6        |      |       |
| yarn 3           | 5, 6        | ✓    | ✓     |
| yarn 4           | 6, 7        | ✓    |       |

### Reference protocols
| Type      | Supported |
|-----------|-----------|
| semver    | ✓         |
| npm       | ✓         |
| workspace |           |
| patch     |           |
| file      |           |
| git       |           |

https://yarnpkg.com/features/protocols

### Caveats
* npm1: `optional: true` label is not supported by `format`
* yarn berry: no idea how to resolve and inject PnP patches https://github.com/yarnpkg/berry/tree/master/packages/plugin-compat
* npm2 and npm3 requires `engines` and `funding` data, while yarn* or npm1 does not contain it
* many `nmtree` projections may correspond the specified `depgraph`

### Inspired by
* [synp](https://github.com/imsnif/synp)
* [snyk-nodejs-lockfile-parser](https://github.com/snyk/nodejs-lockfile-parser)

### License
[MIT](./LICENSE)
